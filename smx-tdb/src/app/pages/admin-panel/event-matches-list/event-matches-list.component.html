<div class="event-matches-list">
  <div class="header-section">
    <h3>Event Matches</h3>
    <div class="controls">
      <mat-form-field appearance="fill" class="event-selector">
        <mat-label>Event</mat-label>
        <mat-select [value]="selectedEvent" (selectionChange)="onEventChange($event.value)">
          <mat-option [value]="null">None</mat-option>
          <mat-option *ngFor="let event of (events$ | async)" [value]="event">
            {{ event.name }} ({{ event.date | date:'shortDate' }})
          </mat-option>
        </mat-select>
      </mat-form-field>
      <button mat-raised-button color="primary" (click)="openAddMatchDialog()" [disabled]="!selectedEventId">
        <mat-icon>add</mat-icon>
        Add Match To Event
      </button>
    </div>
  </div>
  @if (isLoading) {
    <div class="loading">
      <mat-spinner diameter="30"></mat-spinner>
    </div>
  }
  @if (!isLoading && selectedEventId) {
    @if (matches$ | async; as matches) {
      @if (matches.length === 0) {
        <div class="empty-state">
          <p>No matches added to this event yet.</p>
        </div>
      }
      @if (matches.length > 0) {
        <mat-list>
          @for (match of matches; track match?.match_id || $index) {
            <mat-list-item>
              <div class="match-item">
                <div class="match-header">
                  <div class="match-players">
                  @if (match.players && match.players.length > 0) {
                    @for (player of match.players; track player.player_id; let i = $index) {
                      <span class="player">{{ player.gamertag }}</span>
                      @if (i < match.players.length - 1) {
                        <span class="vs">vs</span>
                      }
                    }
                  } @else {
                    <span class="player">No players</span>
                  }
                  </div>
                  <div class="action-buttons">
                    <button mat-icon-button 
                            class="edit-button" 
                            (click)="editMatch(match)"
                            matTooltip="Edit match">
                      <mat-icon>edit</mat-icon>
                    </button>
                    <button mat-icon-button 
                            class="delete-button" 
                            (click)="deleteMatch(match.match_id!)"
                            matTooltip="Delete match">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>
                </div>
                <div class="match-details">
                  @if (match.winner?.gamertag) {
                    <div class="winner">
                      Winner: {{ match.winner?.gamertag }}
                    </div>
                  }
                  @if (match.songs && match.songs.length > 0) {
                    <div class="songs">
                      <span class="songs-label">Songs: </span>
                      @for (song of match.songs; track song.song_id) {
                        <div class="song-item">
                          <span class="song">
                            {{ song.title }}{{ song.artist ? ' - ' + song.artist : '' }}{{ song.chart_display ? ' (' + song.chart_display + ')' : '' }}
                          </span>
                          @if (song.player_scores && song.player_scores.length > 0) {
                            <span class="song-scores">
                              (
                              @for (playerScore of song.player_scores; track playerScore.player_id; let i = $index) {
                                @if (playerScore.win) {
                                  <strong>{{ playerScore.player_gamertag }}: {{ playerScore.score }}</strong>
                                } @else {
                                  {{ playerScore.player_gamertag }}: {{ playerScore.score }}
                                }
                                @if (i < song.player_scores.length - 1) {
                                  <span>, </span>
                                }
                              }
                              )
                            </span>
                          }
                        </div>
                      }
                    </div>
                  }
                </div>
              </div>
            </mat-list-item>
          }
        </mat-list>
      }
    }
  }
  @if (!selectedEventId) {
    <div class="empty-state">
      <p>Select an event to view matches.</p>
    </div>
  }
</div>

